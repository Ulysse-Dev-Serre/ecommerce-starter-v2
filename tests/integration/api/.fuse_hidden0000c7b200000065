/**
 * Cart API - User cart operations
 */
const { setupTest, teardownTest } = require('../../setup/test.setup');
const { PrismaClient } = require('../../../src/generated/prisma');

describe('Cart API - User', () => {
  let client;
  let prisma;
  let testVariantId;

  beforeAll(async () => {
    const setup = await setupTest();
    client = setup.client;
    prisma = new PrismaClient();

    const variant = await prisma.productVariant.findFirst();
    testVariantId = variant.id;
  });

  afterAll(async () => {
    await prisma.$disconnect();
    await teardownTest();
  });

  test('should add and remove item from cart', async () => {
    // Add to cart
    const added = await client.post('/api/cart/items', {
      anonymousId: `test-${Date.now()}`,
      variantId: testVariantId,
      quantity: 2,
    });

    expect(added.success).toBe(true);
    expect(added.status).toBe(201);
    expect(added.data.cart.items).toHaveLength(1);
    expect(added.data.cart.items[0].quantity).toBe(2);

    // Remove from cart
    const itemId = added.data.cart.items[0].id;
    const removed = await client.delete(`/api/cart/items/${itemId}`);

    expect(removed.success).toBe(true);
    expect(removed.data.cartItem.id).toBe(itemId);
  });
});
