# üìú Scripts de gestion du projet

Documentation compl√®te des scripts organis√©e selon un flux logique de d√©veloppement.

---

## üìã Table des mati√®res


1. [Gestion Clerk - Authentification](#-2-gestion-clerk---authentification)
2. [Gestion base de donn√©es - Structure et donn√©es](#-3-gestion-base-de-donn√©es---structure-et-donn√©es)
3. [Tests et validation](#-4-tests-et-validation)
4. [Workflows recommand√©s](#-workflows-recommand√©s)

---


## üë• 1. Gestion Clerk - Authentification

**Ordre logique :** D'abord cr√©er les utilisateurs dans Clerk, ensuite les synchroniser vers PostgreSQL.

### `npm run sync-clerk create`

**Fichier:** `scripts/sync-clerk-users.ts`

**Objectif:** Cr√©er les utilisateurs de test dans Clerk (le syst√®me d'authentification).

**Ce qu'il fait:**
- Cr√©e 3 utilisateurs dans Clerk via l'API :
  - `admin@test.com` (Admin Test, r√¥le admin)
  - `client@test.com` (Jean Dupont, r√¥le client)
  - `marie@test.com` (Marie Martin, r√¥le client)
- Mot de passe par d√©faut : `A_dmin_P@ssw0rd!123`
- √âvite les doublons (v√©rifie avant de cr√©er)

**Utilisation:**
```bash
npm run sync-clerk create
```

**‚ö†Ô∏è Pr√©requis :** Variable `CLERK_SECRET_KEY` configur√©e dans `.env`

---

### `npm run sync-clerk sync`

**Fichier:** `scripts/sync-clerk-users.ts`

**Objectif:** Synchroniser les utilisateurs de Clerk vers PostgreSQL.

**Ce qu'il fait:**
1. R√©cup√®re tous les utilisateurs depuis Clerk (max 100)
2. Pour chaque utilisateur :
   - **Existe en DB** ‚Üí Met √† jour (email, nom, imageUrl, role)
   - **N'existe pas** ‚Üí Cr√©e un nouvel enregistrement
3. D√©termine le r√¥le automatiquement (ADMIN si email contient "admin", sinon CLIENT)
4. Affiche les `clerkId` r√©els pour r√©f√©rence

**Utilisation:**
```bash
npm run sync-clerk sync
```

**Sortie typique:**
```
‚úÖ Utilisateur mis √† jour: admin@test.com
‚úÖ Utilisateur mis √† jour: client@test.com
üÜï Nouvel utilisateur cr√©√©: marie@test.com

```

**üí° √Ä ce stade :** Les utilisateurs existent dans Clerk ET dans PostgreSQL, mais sans donn√©es compl√©mentaires (adresses, etc.).

---

## üóÑÔ∏è 3. Gestion base de donn√©es - Structure et donn√©es

### 3.1 Gestion du sch√©ma (Structure)

#### `npm run db:migrate`

**Objectif:** Cr√©er et appliquer une migration Prisma (pour changements de structure).

**Utilisation:**
```bash
npm run db:migrate
```

**Quand l'utiliser:**
- Apr√®s modification du `schema.prisma`
- G√©n√®re un fichier versionn√© dans `prisma/migrations/`
- **Recommand√© pour production** (historique des changements)

---

#### `npm run db:push`

**Objectif:** Synchroniser le sch√©ma directement sans cr√©er de migration.

**Utilisation:**
```bash
npm run db:push
```

**Diff√©rence avec migrate:**
- Pas de fichier de migration cr√©√©
- **Utile pour prototypage rapide en d√©veloppement**
- Ne pas utiliser en production

---

#### `npm run db:studio`

**Objectif:** Interface graphique pour visualiser et modifier la base de donn√©es.

**Utilisation:**
```bash
npm run db:studio
```

**Interface:** `http://localhost:5555`

**Fonctionnalit√©s:**
- Voir toutes les tables et donn√©es
- Modifier manuellement les enregistrements
- Explorer les relations
- D√©boguer les probl√®mes de donn√©es

---

### 3.2 Gestion des donn√©es (Seeding)

**Ordre logique :** Seed principal ‚Üí Seed produits suppl√©mentaires ‚Üí Nettoyage si n√©cessaire

#### `npm run db:seed`

**Fichier:** `prisma/seed.ts`

**Objectif:** Initialiser la base avec un jeu de donn√©es complet et coh√©rent.

**Ce qu'il fait:**
1. **Nettoie toutes les tables** de la base de donn√©es
2. **Enrichit les utilisateurs** admin et client (cr√©√©s par sync-clerk) :
   - Ajoute des adresses de livraison/facturation
   - Met √† jour les informations compl√®tes
3. **Cr√©e les cat√©gories de base** :
   - Syst√®mes Hydroponiques
   - Capteurs et Monitoring
4. **Cr√©e un attribut produit** : color (vert, blanc)
5. **Cr√©e 2 produits avec variantes** :
   - Syst√®me de Culture Hydroponique (2 variantes)
   - Capteur d'Humidit√© du Sol (2 variantes)
6. **Cr√©e les param√®tres syst√®me** : site_name, currency_default, tax_rate, etc.
7. **Cr√©e un coupon de test** : `WELCOME10` (10% r√©duction, min 50$)

**Utilisation:**
```bash
npm run db:seed
```

**‚ö†Ô∏è Important :** Ce script suppose que les utilisateurs existent d√©j√† dans PostgreSQL (via `sync-clerk sync`).

**üí° R√©sultat :** Base de donn√©es compl√®te avec 2 produits et utilisateurs enrichis.

---

#### `npm run db:seed-products`

**Fichier:** `scripts/seed-products.ts`

**Objectif:** Ajouter des produits suppl√©mentaires SANS toucher aux donn√©es existantes.

**Ce qu'il fait:**
- Ajoute 6 nouveaux produits :
  - Samsung Galaxy S24 (2 variantes)
  - MacBook Pro 14" M3 (1 variante)
  - Dell XPS 15 (1 variante)
  - Hoodie Premium (3 variantes)
  - Jeans Slim Fit (3 variantes)
  - Google Pixel 8 Pro (2 variantes)
- V√©rifie que les cat√©gories existent
- Ignore les produits d√©j√† existants (bas√© sur le slug)
- Cr√©e les traductions FR/EN automatiquement

**Utilisation:**
```bash
npm run db:seed-products
```

**‚ö†Ô∏è Pr√©requis :** Les cat√©gories `smartphones`, `laptops`, `mens-clothing` doivent exister.

**Cas d'usage:**
- Enrichir le catalogue apr√®s seed initial
- Tester la pagination (9 produits au total)
- Ajouter des produits sans perdre les donn√©es

---

### 3.3 Nettoyage et reset

**Ordre logique :** Du moins destructif au plus destructif

#### `npm run db:clean-products`

**Fichier:** `scripts/clean-products.ts`

**Objectif:** Nettoyer TOUT ce qui est li√© aux produits (garde uniquement les utilisateurs).

**Ce qu'il supprime (dans l'ordre):**
1. **Avis produits** (Review)
2. **Items de panier** (CartItem)
3. **Paniers** (Cart)
4. **Produits** avec cascade automatique:
   - ProductTranslation
   - ProductCategory (liens)
   - ProductVariant
   - ProductVariantPricing
   - ProductVariantInventory
   - ProductVariantAttributeValue
   - ProductMedia
5. **Attributs produits** avec cascade:
   - ProductAttribute
   - ProductAttributeTranslation
   - ProductAttributeValue
   - ProductAttributeValueTranslation
6. **Cat√©gories** avec cascade:
   - Category
   - CategoryTranslation

**Conserve uniquement:**
- ‚úÖ Utilisateurs et r√¥les
- ‚úÖ Adresses utilisateurs
- ‚úÖ Param√®tres syst√®me
- ‚úÖ Coupons
- ‚úÖ Commandes (Order, OrderItem, Payment, Shipment)
- ‚úÖ Webhooks
- ‚úÖ Logs d'audit

**Utilisation:**
```bash
npm run db:clean-products
```

**Cas d'usage:**
- Vider le catalogue avant de tester l'ajout manuel via dashboard
- Nettoyer sans perdre les utilisateurs Clerk synchronis√©s
- Recommencer les tests produits sur une base propre

---

#### `npm run db:reset`

**Fichier:** `scripts/reset-local.ts`

**Objectif:** Reset COMPLET de l'environnement (Clerk + Base de donn√©es).

**Ce qu'il fait:**
1. **Supprime les utilisateurs de Clerk** :
   - Tous les emails `@test.com`
   - Utilisateurs list√©s dans `testEmails[]`
2. **Supprime et recr√©e la base de donn√©es** :
   - Ex√©cute `prisma migrate reset --force`
   - **NE lance PAS le seed automatiquement** (`--skip-seed`)

**Utilisation:**
```bash
npm run db:reset
```

**‚ö†Ô∏è ATTENTION :** Cette commande est DESTRUCTIVE ! Elle supprime :
- ‚ùå Tous les utilisateurs Clerk de test
- ‚ùå Toute la base de donn√©es (structure + donn√©es)

**üí° Apr√®s ce reset :** Vous devez recommencer tout le workflow (voir section Workflows).

---

## üß™ 4. Tests et validation

### Tests automatis√©s (Jest)

#### `npm run test`

**Objectif:** Ex√©cuter tous les tests unitaires et d'int√©gration.

**Tests inclus:**
- 3 tests Health API
- 1 test Cart API
- **Total : 4 tests**

**Utilisation:**
```bash
npm run test
```

**‚ö†Ô∏è Pr√©requis :** Serveur lanc√© (`npm run dev`) et base de donn√©es accessible.

---

#### `npm run test:watch`

**Objectif:** Tests en mode watch (re-ex√©cution automatique).

**Utilisation:**
```bash
npm run test:watch
```

---

### Scripts de test manuels

#### `npm run test:db`

**Fichier:** `tests/scripts/database-test.js`

**Objectif:** Test rapide de connexion et op√©rations CRUD.

**Utilisation:**
```bash
npm run test:db
```

---

#### `npm run test:webhook`

**Fichier:** `tests/scripts/webhook-debug.js`

**Objectif:** Serveur de debug pour intercepter les webhooks Clerk.

**Utilisation:**
```bash
npm run test:webhook
```

**Serveur:** `http://localhost:3001/test-webhook`

---

#### Validation compl√®te

**Fichier:** `tests/scripts/validate-features.js`

**Objectif:** Validation compl√®te de toutes les fonctionnalit√©s cl√©s.

**Tests inclus:** 8 tests (health, database, produits, admin, r√¥les, panier, stock, webhooks)

**Utilisation:**
```bash
node tests/scripts/validate-features.js
```

**R√©sultat attendu :** Taux de r√©ussite 100%

---

## üìä Workflows recommand√©s

### üÜï Workflow 1 : Configuration initiale du projet

**Situation :** Vous clonez le projet pour la premi√®re fois.

```bash
# 1. Installer les d√©pendances
npm install

# 2. Configurer les variables d'environnement
cp .env.example .env
# √âditer .env.local avec vos cl√©s Clerk et DATABASE_URL

# 3. Cr√©er la structure de la base de donn√©es
npm run db:migrate

# 4. CLERK : Cr√©er les utilisateurs de test dans Clerk
npm run sync-clerk create
# ‚ûú Cr√©e admin@test.com, client@test.com, marie@test.com dans Clerk

# 5. CLERK : Synchroniser Clerk ‚Üí PostgreSQL
npm run sync-clerk sync
# ‚ûú Copie les 3 utilisateurs dans PostgreSQL avec leurs clerkId r√©els

# 6. DATABASE : Seed complet (enrichit admin/client + produits de base)
npm run db:seed
# ‚ûú Ajoute adresses, cat√©gories, 2 produits, param√®tres, coupons

# 7. DATABASE : Ajouter plus de produits (optionnel)
npm run db:seed-products
# ‚ûú Ajoute 6 produits suppl√©mentaires (9 au total)

# 8. Valider que tout fonctionne
node tests/scripts/validate-features.js
# ‚ûú Doit afficher : 8/8 tests r√©ussis ‚úÖ

# 9. Lancer le serveur
npm run dev
```



### üîÑ Workflow 2 : Reset COMPLET (tout recommencer √† z√©ro)

**Situation :** Vous voulez repartir de z√©ro (Clerk + Database).

```bash
# 1. Reset TOTAL (Clerk + DB)
npm run db:reset

# 2. Recr√©er les utilisateurs dans Clerk
npm run sync-clerk create

# 3. Synchroniser Clerk ‚Üí PostgreSQL
npm run sync-clerk sync

# 4. Seed complet
npm run db:seed

# 5. Ajouter plus de produits (optionnel)
npm run db:seed-products

# 6. Valider
node tests/scripts/validate-features.js
```

---

### üõçÔ∏è Workflow 3 : Reset UNIQUEMENT les produits

**Situation :** Vous voulez vider le catalogue mais garder les utilisateurs.

```bash
# 1. Nettoyer uniquement les produits et paniers
npm run db:clean-products

# 2. Ajouter de nouveaux produits
npm run db:seed-products
# ou relancer le seed complet si vous voulez aussi les 2 produits de base
```

**‚úÖ Avantage :** Les utilisateurs Clerk sont pr√©serv√©s (pas besoin de resync).

---

### üîß Workflow 4 : D√©veloppement quotidien

```bash
# Terminal 1 : Serveur
npm run dev

# Terminal 2 : Tests en continu
npm run test:watch

# Terminal 3 : V√©rifications TypeScript
npm run typecheck
```

---

### ‚úÖ Workflow 5 : Avant un commit

```bash
# Option 1 : Corriger automatiquement
npm run ci:fix

# Option 2 : V√©rifier sans modifier
npm run ci
```

---

## üìù Points cl√©s √† retenir

### Ordre logique de setup

```
1Ô∏è‚É£ CLERK      : sync-clerk create    (Cr√©er utilisateurs dans Clerk)
2Ô∏è‚É£ CLERK      : sync-clerk sync      (Copier vers PostgreSQL)
3Ô∏è‚É£ DATABASE   : db:seed              (Enrichir donn√©es + 2 produits)
4Ô∏è‚É£ DATABASE   : db:seed-products     (Ajouter 6 produits - optionnel)
```



### Environnements

- ‚ö†Ô∏è Les scripts de reset/clean sont pour **d√©veloppement local uniquement**
- ‚ùå **Ne JAMAIS ex√©cuter en production**

### Migrations vs Push

- `db:migrate` ‚Üí Cr√©e un fichier de migration (versionn√©, pour prod)
- `db:push` ‚Üí Synchronisation directe (prototype rapide, dev only)

---


